name: Deploy to Server

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: true

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp -r server deploy/
          cp -r database deploy/
          cp package.json package-lock.json deploy/
          cp nginx.conf deploy/
          tar -czf deploy.tar.gz -C deploy .

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          strip_components: 0

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            # 检查是否 root 用户
            IS_ROOT=false
            if [ "$USER" = "root" ] || [ "$(id -u)" = "0" ]; then
              IS_ROOT=true
            fi

            run_sudo() {
              if [ "$IS_ROOT" = "true" ]; then
                eval "$@"
              else
                sudo "$@"
              fi
            }

            DEPLOY_DIR="/opt/learnEnglish"
            BACKUP_DIR="/opt/learnEnglish/backup"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "========================================="
            echo "  开始部署 LearnEnglish (用户: $USER)"
            echo "========================================="
            echo ""

            run_sudo mkdir -p $BACKUP_DIR

            # 备份数据库
            if [ -f "$DEPLOY_DIR/database/learning_progress.db" ]; then
              echo "备份数据库..."
              run_sudo cp $DEPLOY_DIR/database/learning_progress.db $BACKUP_DIR/database_$TIMESTAMP.db
              echo "数据库备份完成: $BACKUP_DIR/database_$TIMESTAMP.db"
            fi

            if [ -d "$DEPLOY_DIR/dist" ]; then
              echo "备份当前版本..."
              run_sudo cp -r $DEPLOY_DIR/dist $BACKUP_DIR/dist_$TIMESTAMP
              echo "备份完成: $BACKUP_DIR/dist_$TIMESTAMP"
            fi

            echo ""
            echo "解压部署包..."
            cd /tmp
            tar -xzf deploy.tar.gz

            # 更新前端
            echo "更新前端..."
            run_sudo rm -rf $DEPLOY_DIR/dist_new
            run_sudo mv /tmp/dist $DEPLOY_DIR/dist_new

            # 更新后端和数据库代码
            echo "更新后端和数据库..."
            run_sudo rm -rf $DEPLOY_DIR/server_new
            run_sudo mv /tmp/server $DEPLOY_DIR/server_new
            run_sudo rm -rf $DEPLOY_DIR/database_new
            run_sudo mv /tmp/database $DEPLOY_DIR/database_new
            run_sudo mv /tmp/package.json $DEPLOY_DIR/package.json.new
            run_sudo mv /tmp/package-lock.json $DEPLOY_DIR/package-lock.json.new
            run_sudo mv /tmp/nginx.conf $DEPLOY_DIR/nginx.conf.new
            rm -f /tmp/deploy.tar.gz

            echo "切换到新版本..."
            run_sudo rm -rf $DEPLOY_DIR/dist
            run_sudo mv $DEPLOY_DIR/dist_new $DEPLOY_DIR/dist

            # 备份并替换数据库代码（保留数据库文件）
            if [ -f "$DEPLOY_DIR/database/learning_progress.db" ]; then
              run_sudo cp $DEPLOY_DIR/database/learning_progress.db $DEPLOY_DIR/database_new/learning_progress.db
            fi
            run_sudo rm -rf $DEPLOY_DIR/database
            run_sudo mv $DEPLOY_DIR/database_new $DEPLOY_DIR/database

            run_sudo rm -rf $DEPLOY_DIR/server
            run_sudo mv $DEPLOY_DIR/server_new $DEPLOY_DIR/server

            run_sudo mv $DEPLOY_DIR/package.json.new $DEPLOY_DIR/package.json
            run_sudo mv $DEPLOY_DIR/package-lock.json.new $DEPLOY_DIR/package-lock.json

            echo "安装后端依赖..."
            cd $DEPLOY_DIR
            run_sudo npm install --production=false

            echo "初始化数据库（如果不存在）..."
            if [ ! -f "$DEPLOY_DIR/database/learning_progress.db" ]; then
              cd $DEPLOY_DIR
              run_sudo npm run db:init
            fi

            echo "更新 Nginx 配置..."
            run_sudo cp $DEPLOY_DIR/nginx.conf.new /etc/nginx/conf.d/learn-english.conf
            run_sudo rm -f $DEPLOY_DIR/nginx.conf.new

            # 配置 API 反向代理
            echo '# API 服务器反向代理' | run_sudo tee /tmp/learn-english-api.conf
            echo 'upstream backend {' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    server 127.0.0.1:3001;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '}' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '' | run_sudo tee -a /tmp/learn-english-api.conf
            echo 'server {' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    listen 80;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    server_name _;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    # API 请求转发到后端' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    location /api/ {' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_pass http://backend;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_http_version 1.1;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_set_header Upgrade $http_upgrade;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_set_header Connection '\'''\''upgrade'\'';\''' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_set_header Host $host;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_set_header X-Real-IP $remote_addr;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '        proxy_cache_bypass $http_upgrade;' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '    }' | run_sudo tee -a /tmp/learn-english-api.conf
            echo '}' | run_sudo tee -a /tmp/learn-english-api.conf
            run_sudo mv /tmp/learn-english-api.conf /etc/nginx/conf.d/learn-english-api.conf

            echo "测试 Nginx 配置..."
            run_sudo nginx -t

            echo "重启后端服务..."
            if command -v pm2 &> /dev/null; then
              cd $DEPLOY_DIR
              if pm2 list | grep -q "learnenglish-api"; then
                run_sudo pm2 restart learnenglish-api
              else
                run_sudo pm2 start server/index.js --name learnenglish-api
              fi
              run_sudo pm2 save
            else
              echo "警告: PM2 未安装，后端服务未启动"
            fi

            echo "重启 Nginx..."
            run_sudo systemctl reload nginx

            echo "清理旧备份..."
            cd $BACKUP_DIR 2>/dev/null || true
            ls -t 2>/dev/null | tail -n +6 | while read dir; do run_sudo rm -rf "$dir"; done

            echo ""
            echo "========================================="
            echo "  部署完成！"
            echo "========================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "部署成功！"
          else
            echo "部署失败，请检查日志。"
          fi
