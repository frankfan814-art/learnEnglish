name: Deploy to Server

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          CI: true

      - name: Create deployment package
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp nginx.conf deploy/
          tar -czf deploy.tar.gz -C deploy .

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/tmp/"
          strip_components: 0

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: true
          script: |
            # 检查是否 root 用户
            IS_ROOT=false
            if [ "$USER" = "root" ] || [ "$(id -u)" = "0" ]; then
              IS_ROOT=true
            fi

            run_sudo() {
              if [ "$IS_ROOT" = "true" ]; then
                eval "$@"
              else
                sudo "$@"
              fi
            }

            DEPLOY_DIR="/opt/learnEnglish"
            BACKUP_DIR="/opt/learnEnglish/backup"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "========================================="
            echo "  开始部署 LearnEnglish (用户: $USER)"
            echo "========================================="
            echo ""

            run_sudo mkdir -p $BACKUP_DIR

            if [ -d "$DEPLOY_DIR/dist" ]; then
              echo "备份当前版本..."
              run_sudo cp -r $DEPLOY_DIR/dist $BACKUP_DIR/dist_$TIMESTAMP
              echo "备份完成: $BACKUP_DIR/dist_$TIMESTAMP"
            fi

            echo ""
            echo "解压部署包..."
            cd /tmp
            tar -xzf deploy.tar.gz

            run_sudo rm -rf $DEPLOY_DIR/dist_new
            run_sudo mv /tmp/dist $DEPLOY_DIR/dist_new
            run_sudo mv /tmp/nginx.conf $DEPLOY_DIR/nginx.conf.new
            rm -f /tmp/deploy.tar.gz

            echo "切换到新版本..."
            run_sudo rm -rf $DEPLOY_DIR/dist
            run_sudo mv $DEPLOY_DIR/dist_new $DEPLOY_DIR/dist

            echo "更新 Nginx 配置..."
            run_sudo cp $DEPLOY_DIR/nginx.conf.new /etc/nginx/conf.d/learn-english.conf
            run_sudo rm -f $DEPLOY_DIR/nginx.conf.new

            echo "测试 Nginx 配置..."
            run_sudo nginx -t

            echo "重启 Nginx..."
            run_sudo systemctl reload nginx

            echo "清理旧备份..."
            cd $BACKUP_DIR 2>/dev/null || true
            ls -t 2>/dev/null | tail -n +6 | while read dir; do run_sudo rm -rf "$dir"; done

            echo ""
            echo "========================================="
            echo "  部署完成！"
            echo "========================================="

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "部署成功！"
          else
            echo "部署失败，请检查日志。"
          fi
