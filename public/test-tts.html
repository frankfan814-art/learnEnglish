<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TTS è¯Šæ–­å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .section h2 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #555;
    }
    .status {
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin: 5px 0;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .info-label {
      font-weight: 500;
      color: #666;
    }
    .info-value {
      color: #333;
      font-family: monospace;
    }
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #00ff00;
      padding-left: 10px;
    }
    .log-entry.error {
      border-left-color: #ff0000;
      color: #ff6666;
    }
    .log-entry.success {
      border-left-color: #00ff00;
      color: #66ff66;
    }
    .log-entry.info {
      border-left-color: #0099ff;
      color: #66ccff;
    }
    .audio-player {
      margin-top: 10px;
    }
    audio {
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”Š TTS è¯­éŸ³è¯Šæ–­å·¥å…·</h1>

    <!-- æµè§ˆå™¨ä¿¡æ¯ -->
    <div class="section">
      <h2>ğŸ“± è®¾å¤‡ä¿¡æ¯</h2>
      <div id="device-info"></div>
    </div>

    <!-- API è¿æ¥æµ‹è¯• -->
    <div class="section">
      <h2>ğŸ”Œ API è¿æ¥æµ‹è¯•</h2>
      <button onclick="testAPIConnection()">æµ‹è¯• /api/tts è¿æ¥</button>
      <div id="api-status"></div>
    </div>

    <!-- æ’­æ”¾æµ‹è¯• -->
    <div class="section">
      <h2>ğŸµ æ’­æ”¾æµ‹è¯•</h2>
      <button onclick="testBlobPlay()">æ–¹å¼ 1: Blob URL æ’­æ”¾</button>
      <button onclick="testDataURLPlay()">æ–¹å¼ 2: Data URL æ’­æ”¾</button>
      <button onclick="testElementPlay()">æ–¹å¼ 3: Audio å…ƒç´ æ’­æ”¾</button>
      <button onclick="testWebSpeech()">æ–¹å¼ 4: Web Speech API</button>
      <div id="audio-status"></div>
      <div id="audio-container"></div>
    </div>

    <!-- æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    // æ—¥å¿—åŠŸèƒ½
    const logDiv = document.getElementById('log')
    function log(message, type = 'info') {
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      logDiv.appendChild(entry)
      logDiv.scrollTop = logDiv.scrollHeight
      console.log(`[${type.toUpperCase()}]`, message)
    }

    // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
    function showDeviceInfo() {
      const ua = navigator.userAgent
      const isMobile = /Android|webOS|iPhone|iPad|iPod/i.test(ua)
      const isAndroid = /Android/i.test(ua)
      const isXiaomi = /xiaomi|redmi|mi\s+/i.test(ua)
      const isChrome = /Chrome/i.test(ua)

      const audio = document.createElement('audio')
      const supportsMP3 = audio.canPlayType('audio/mpeg') !== ''
      const supportsWebM = audio.canPlayType('audio/webm') !== ''
      const hasWebSpeechAPI = 'speechSynthesis' in window

      const info = document.getElementById('device-info')
      info.innerHTML = `
        <div class="info-item">
          <span class="info-label">ç”¨æˆ·ä»£ç†</span>
          <span class="info-value">${ua.substring(0, 100)}...</span>
        </div>
        <div class="info-item">
          <span class="info-label">ç§»åŠ¨è®¾å¤‡</span>
          <span class="info-value">${isMobile ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Android</span>
          <span class="info-value">${isAndroid ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">å°ç±³è®¾å¤‡</span>
          <span class="info-value">${isXiaomi ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Chrome</span>
          <span class="info-value">${isChrome ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">æ”¯æŒ MP3</span>
          <span class="info-value">${supportsMP3 ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">æ”¯æŒ WebM</span>
          <span class="info-value">${supportsWebM ? 'æ˜¯' : 'å¦'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Web Speech API</span>
          <span class="info-value">${hasWebSpeechAPI ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}</span>
        </div>
      `

      log('è®¾å¤‡ä¿¡æ¯å·²åŠ è½½', 'info')
      if (isXiaomi) log('æ£€æµ‹åˆ°å°ç±³è®¾å¤‡ï¼Œå°†ä½¿ç”¨å…¼å®¹æ¨¡å¼', 'info')
    }

    // æµ‹è¯• API è¿æ¥
    async function testAPIConnection() {
      const statusDiv = document.getElementById('api-status')
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨æµ‹è¯• API è¿æ¥...</div>'
      log('å¼€å§‹æµ‹è¯• API è¿æ¥...', 'info')

      try {
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: 'Hello', voice: 'en-US-GuyNeural' })
        })

        log(`API å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 'info')

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }

        const contentType = response.headers.get('content-type')
        log(`Content-Type: ${contentType}`, 'info')

        const arrayBuffer = await response.arrayBuffer()
        const size = arrayBuffer.byteLength
        log(`æ”¶åˆ°éŸ³é¢‘æ•°æ®: ${size} å­—èŠ‚`, 'success')

        statusDiv.innerHTML = `<div class="status success">âœ“ API è¿æ¥æˆåŠŸï¼æ”¶åˆ° ${size} å­—èŠ‚éŸ³é¢‘æ•°æ®</div>`
        return arrayBuffer

      } catch (error) {
        log(`API è¿æ¥å¤±è´¥: ${error.message}`, 'error')
        statusDiv.innerHTML = `<div class="status error">âœ— API è¿æ¥å¤±è´¥: ${error.message}</div>`
        return null
      }
    }

    // è·å–éŸ³é¢‘æ•°æ®
    async function getAudioData() {
      try {
        const response = await fetch('/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: 'Hello world', voice: 'en-US-GuyNeural' })
        })

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`)
        }

        return await response.arrayBuffer()
      } catch (error) {
        log(`è·å–éŸ³é¢‘å¤±è´¥: ${error.message}`, 'error')
        return null
      }
    }

    // æ–¹å¼ 1: Blob URL æ’­æ”¾
    async function testBlobPlay() {
      const statusDiv = document.getElementById('audio-status')
      const audioContainer = document.getElementById('audio-container')
      audioContainer.innerHTML = ''

      log('æµ‹è¯•æ–¹å¼ 1: Blob URL æ’­æ”¾', 'info')
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨è·å–éŸ³é¢‘...</div>'

      const arrayBuffer = await getAudioData()
      if (!arrayBuffer) {
        statusDiv.innerHTML = '<div class="status error">è·å–éŸ³é¢‘å¤±è´¥</div>'
        return
      }

      try {
        const audioBlob = new Blob([arrayBuffer], { type: 'audio/mpeg' })
        const audioUrl = URL.createObjectURL(audioBlob)
        log(`åˆ›å»º Blob URL: ${audioUrl}`, 'info')

        const audio = new Audio(audioUrl)

        audio.onloadedmetadata = () => {
          log(`éŸ³é¢‘æ—¶é•¿: ${audio.duration}ç§’`, 'info')
        }

        audio.onended = () => {
          log('æ’­æ”¾å®Œæˆ', 'success')
          statusDiv.innerHTML = '<div class="status success">âœ“ Blob URL æ’­æ”¾æˆåŠŸï¼</div>'
          URL.revokeObjectURL(audioUrl)
        }

        audio.onerror = (e) => {
          log(`Blob æ’­æ”¾é”™è¯¯: ${e}`, 'error')
          statusDiv.innerHTML = '<div class="status error">âœ— Blob URL æ’­æ”¾å¤±è´¥</div>'
        }

        await audio.play()
        log('å¼€å§‹æ’­æ”¾...', 'info')

        audioContainer.innerHTML = `
          <div class="audio-player">
            <audio controls src="${audioUrl}"></audio>
          </div>
        `
      } catch (error) {
        log(`Blob æ–¹å¼å¤±è´¥: ${error.message}`, 'error')
        statusDiv.innerHTML = `<div class="status error">âœ— å¤±è´¥: ${error.message}</div>`
      }
    }

    // æ–¹å¼ 2: Data URL æ’­æ”¾
    async function testDataURLPlay() {
      const statusDiv = document.getElementById('audio-status')
      const audioContainer = document.getElementById('audio-container')
      audioContainer.innerHTML = ''

      log('æµ‹è¯•æ–¹å¼ 2: Data URL æ’­æ”¾', 'info')
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨è·å–éŸ³é¢‘...</div>'

      const arrayBuffer = await getAudioData()
      if (!arrayBuffer) {
        statusDiv.innerHTML = '<div class="status error">è·å–éŸ³é¢‘å¤±è´¥</div>'
        return
      }

      try {
        const uint8Array = new Uint8Array(arrayBuffer)
        let binary = ''
        for (let i = 0; i < uint8Array.length; i++) {
          binary += String.fromCharCode(uint8Array[i])
        }
        const base64 = btoa(binary)
        const dataUrl = `data:audio/mpeg;base64,${base64}`

        log(`Data URL é•¿åº¦: ${dataUrl.length} å­—ç¬¦`, 'info')

        const audio = new Audio(dataUrl)

        audio.onended = () => {
          log('æ’­æ”¾å®Œæˆ', 'success')
          statusDiv.innerHTML = '<div class="status success">âœ“ Data URL æ’­æ”¾æˆåŠŸï¼</div>'
        }

        audio.onerror = (e) => {
          log(`Data URL æ’­æ”¾é”™è¯¯: ${e}`, 'error')
          statusDiv.innerHTML = '<div class="status error">âœ— Data URL æ’­æ”¾å¤±è´¥</div>'
        }

        await audio.play()
        log('å¼€å§‹æ’­æ”¾...', 'info')

      } catch (error) {
        log(`Data URL æ–¹å¼å¤±è´¥: ${error.message}`, 'error')
        statusDiv.innerHTML = `<div class="status error">âœ— å¤±è´¥: ${error.message}</div>`
      }
    }

    // æ–¹å¼ 3: Audio å…ƒç´ æ’­æ”¾
    async function testElementPlay() {
      const statusDiv = document.getElementById('audio-status')
      const audioContainer = document.getElementById('audio-container')
      audioContainer.innerHTML = ''

      log('æµ‹è¯•æ–¹å¼ 3: HTML5 Audio å…ƒç´ æ’­æ”¾', 'info')
      statusDiv.innerHTML = '<div class="status info">æ­£åœ¨è·å–éŸ³é¢‘...</div>'

      const arrayBuffer = await getAudioData()
      if (!arrayBuffer) {
        statusDiv.innerHTML = '<div class="status error">è·å–éŸ³é¢‘å¤±è´¥</div>'
        return
      }

      try {
        // ç§»é™¤æ—§å…ƒç´ 
        const oldElement = document.getElementById('test-audio-element')
        if (oldElement) oldElement.remove()

        const audio = document.createElement('audio')
        audio.id = 'test-audio-element'

        const uint8Array = new Uint8Array(arrayBuffer)
        let binary = ''
        for (let i = 0; i < uint8Array.length; i++) {
          binary += String.fromCharCode(uint8Array[i])
        }
        const base64 = btoa(binary)
        const dataUrl = `data:audio/mpeg;base64,${base64}`

        audio.src = dataUrl
        audio.setAttribute('webkit-playsinline', 'true')
        audio.setAttribute('playsinline', 'true')
        audio.controls = true
        audio.style.width = '100%'

        audio.onended = () => {
          log('æ’­æ”¾å®Œæˆ', 'success')
          statusDiv.innerHTML = '<div class="status success">âœ“ Audio å…ƒç´ æ’­æ”¾æˆåŠŸï¼</div>'
        }

        audio.onerror = (e) => {
          log(`Audio å…ƒç´ é”™è¯¯: ${e}`, 'error')
          statusDiv.innerHTML = '<div class="status error">âœ— Audio å…ƒç´ æ’­æ”¾å¤±è´¥</div>'
        }

        audioContainer.appendChild(audio)

        await audio.play()
        log('å¼€å§‹æ’­æ”¾...', 'info')

      } catch (error) {
        log(`Audio å…ƒç´ æ–¹å¼å¤±è´¥: ${error.message}`, 'error')
        statusDiv.innerHTML = `<div class="status error">âœ— å¤±è´¥: ${error.message}</div>`
      }
    }

    // æ–¹å¼ 4: Web Speech API
    async function testWebSpeech() {
      const statusDiv = document.getElementById('audio-status')
      const audioContainer = document.getElementById('audio-container')
      audioContainer.innerHTML = ''

      log('æµ‹è¯•æ–¹å¼ 4: Web Speech API', 'info')

      if (!('speechSynthesis' in window)) {
        log('æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API', 'error')
        statusDiv.innerHTML = '<div class="status error">âœ— æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API</div>'
        return
      }

      try {
        window.speechSynthesis.cancel()

        const utterance = new SpeechSynthesisUtterance('Hello world, this is a test')
        utterance.lang = 'en-US'
        utterance.rate = 0.9
        utterance.pitch = 1

        utterance.onstart = () => {
          log('å¼€å§‹è¯´è¯...', 'info')
        }

        utterance.onend = () => {
          log('è¯´è¯å®Œæˆ', 'success')
          statusDiv.innerHTML = '<div class="status success">âœ“ Web Speech API æ’­æ”¾æˆåŠŸï¼</div>'
        }

        utterance.onerror = (e) => {
          log(`Web Speech API é”™è¯¯: ${e}`, 'error')
          statusDiv.innerHTML = '<div class="status error">âœ— Web Speech API æ’­æ”¾å¤±è´¥</div>'
        }

        window.speechSynthesis.speak(utterance)

      } catch (error) {
        log(`Web Speech API å¤±è´¥: ${error.message}`, 'error')
        statusDiv.innerHTML = `<div class="status error">âœ— å¤±è´¥: ${error.message}</div>`
      }
    }

    // åˆå§‹åŒ–
    showDeviceInfo()
    log('è¯Šæ–­å·¥å…·å·²å°±ç»ª', 'success')
    log('è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œæµ‹è¯•', 'info')
  </script>
</body>
</html>
