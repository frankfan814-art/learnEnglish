<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç±³éŸ³é¢‘è¯Šæ–­å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 15px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 5px;
      font-size: 20px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 15px;
      font-size: 12px;
    }

    .device-info {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 12px;
      text-align: center;
    }

    .device-info.xiaomi {
      background: #fff3e0;
      border: 1px solid #ffb74d;
    }

    .section {
      margin-bottom: 15px;
    }

    .section-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .btn-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.1s;
    }

    button:active {
      transform: scale(0.95);
    }

    button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    .results {
      background: #1e1e1e;
      color: #00ff00;
      border-radius: 8px;
      padding: 10px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }

    .result-item {
      margin-bottom: 4px;
    }

    .result-item.success {
      color: #51cf66;
    }

    .result-item.error {
      color: #ff6b6b;
    }

    .word-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .word-btn {
      background: #f0f0f0;
      color: #333;
      border: none;
      padding: 10px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .test-word {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 40px 50px;
      border-radius: 20px;
      font-size: 48px;
      font-weight: bold;
      z-index: 99999;
      display: none;
      animation: showWord 1s ease-out;
    }

    @keyframes showWord {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”Š å°ç±³éŸ³é¢‘è¯Šæ–­å·¥å…·</h1>
    <p class="subtitle">æµ‹è¯•å„ç§éŸ³é¢‘æ’­æ”¾æ–¹æ¡ˆ</p>

    <div class="device-info" id="deviceInfo">
      æ£€æµ‹è®¾å¤‡ä¸­...
    </div>

    <div class="section">
      <div class="section-title">ğŸ“‹ åŸºç¡€æµ‹è¯•</div>
      <div class="btn-grid">
        <button onclick="runFullDiagnostic()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        <button onclick="testWebAudio()" class="secondary">æµ‹è¯• Web Audio</button>
        <button onclick="testHTML5Audio()" class="secondary">æµ‹è¯• HTML5 Audio</button>
        <button onclick="testWebSpeech()" class="secondary">æµ‹è¯•è¯­éŸ³åˆæˆ</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ”Š éŸ³é¢‘æµ‹è¯•</div>
      <div class="btn-grid">
        <button onclick="playTone(440)">æ’­æ”¾ 440Hz éŸ³è°ƒ</button>
        <button onclick="playTone(880)">æ’­æ”¾ 880Hz éŸ³è°ƒ</button>
        <button onclick="playChord()">æ’­æ”¾å’Œå¼¦</button>
        <button onclick="playSequence()" class="secondary">æ’­æ”¾éŸ³åº</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ—£ï¸ è¯­éŸ³æµ‹è¯•</div>
      <div class="word-buttons">
        <button class="word-btn" onclick="testSpeak('hello')">hello</button>
        <button class="word-btn" onclick="testSpeak('world')">world</button>
        <button class="word-btn" onclick="testSpeak('test')">test</button>
        <button class="word-btn" onclick="testSpeak('apple')">apple</button>
        <button class="word-btn" onclick="testSpeak('banana')">banana</button>
        <button class="word-btn" onclick="testSpeak('orange')">orange</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">ğŸ”„ å¤‡é€‰æ–¹æ¡ˆ</div>
      <div class="btn-grid">
        <button onclick="testFallback('hello')">å¤‡é€‰éŸ³é¢‘ hello</button>
        <button onclick="testVisual('test')">è§†è§‰åé¦ˆ test</button>
        <button onclick="testVibrate()" class="secondary">æµ‹è¯•æŒ¯åŠ¨</button>
        <button onclick="testAll()" class="secondary">æµ‹è¯•æ‰€æœ‰æ–¹æ¡ˆ</button>
      </div>
    </div>

    <div class="results" id="results">
      <div class="result-item">ç­‰å¾…æµ‹è¯•...</div>
    </div>
  </div>

  <div class="test-word" id="testWord"></div>

  <script>
    const results = document.getElementById('results');

    // æ£€æµ‹è®¾å¤‡
    function detectDevice() {
      const ua = navigator.userAgent;
      const isXiaomi = /xiaomi|redmi|mi\s+/i.test(ua) ||
                       ua.includes('MIUI') ||
                       ua.includes('MiuiBrowser');

      const deviceInfo = document.getElementById('deviceInfo');
      deviceInfo.className = `device-info ${isXiaomi ? 'xiaomi' : ''}`;
      deviceInfo.innerHTML = `
        <strong>${isXiaomi ? 'ğŸ”´ å°ç±³è®¾å¤‡' : 'ğŸŸ¢ å…¶ä»–è®¾å¤‡'}</strong><br>
        ${ua.substring(0, 80)}...
      `;

      return isXiaomi;
    }

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `result-item ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      results.appendChild(entry);
      results.scrollTop = results.scrollHeight;
      console.log(message);
    }

    // Web Audio æµ‹è¯•
    async function testWebAudio() {
      log('ğŸ” æµ‹è¯• Web Audio API...', 'info');
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) {
          log('âŒ AudioContext ä¸å­˜åœ¨', 'error');
          return;
        }

        const ctx = new AudioContext();
        log(`AudioContext çŠ¶æ€: ${ctx.state}`, 'info');

        if (ctx.state === 'suspended') {
          await ctx.resume();
          log(`AudioContext å·²æ¢å¤: ${ctx.state}`, 'success');
        }

        // æ’­æ”¾æµ‹è¯•éŸ³
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(440, ctx.currentTime);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);

        log('âœ… æ’­æ”¾ 440Hz æµ‹è¯•éŸ³ï¼ˆåº”è¯¥å¬åˆ°"æ»´"å£°ï¼‰', 'success');

        setTimeout(() => {
          if (ctx.state !== 'closed') ctx.close();
        }, 400);
      } catch (error) {
        log(`âŒ Web Audio å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // HTML5 Audio æµ‹è¯•
    async function testHTML5Audio() {
      log('ğŸ” æµ‹è¯• HTML5 Audio...', 'info');
      try {
        const audio = new Audio();
        audio.src = 'data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAKGF0YQAAAAA=';
        audio.volume = 0.5;
        await audio.play();
        log('âœ… HTML5 Audio æ’­æ”¾æˆåŠŸ', 'success');
      } catch (error) {
        log(`âŒ HTML5 Audio å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // Web Speech æµ‹è¯•
    async function testWebSpeech() {
      log('ğŸ” æµ‹è¯• Web Speech API...', 'info');
      if (!('speechSynthesis' in window)) {
        log('âŒ speechSynthesis ä¸å­˜åœ¨', 'error');
        return;
      }

      const voices = window.speechSynthesis.getVoices();
      log(`å¯ç”¨è¯­éŸ³: ${voices.length} ä¸ª`, 'info');

      const utterance = new SpeechSynthesisUtterance('hello test');
      utterance.lang = 'en-US';
      utterance.rate = 0.8;
      utterance.volume = 1.0;

      utterance.onstart = () => log('âœ… onstart è§¦å‘ï¼ˆæ³¨æ„ï¼šå¯èƒ½æ²¡å£°éŸ³ï¼‰', 'success');
      utterance.onend = () => log('âœ… onend è§¦å‘', 'success');
      utterance.onerror = (e) => log(`âŒ onerror: ${e.error}`, 'error');

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    // æ’­æ”¾éŸ³è°ƒ
    async function playTone(freq) {
      log(`ğŸ”Š æ’­æ”¾ ${freq}Hz éŸ³è°ƒ...`, 'info');
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') await ctx.resume();

        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.setValueAtTime(freq, ctx.currentTime);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);

        log(`âœ… ${freq}Hz æ’­æ”¾å®Œæˆ`, 'success');

        setTimeout(() => {
          if (ctx.state !== 'closed') ctx.close();
        }, 400);
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ’­æ”¾å’Œå¼¦
    async function playChord() {
      log('ğŸµ æ’­æ”¾å’Œå¼¦ (Cå¤§è°ƒ)...', 'info');
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') await ctx.resume();

        const frequencies = [261.63, 329.63, 392.00]; // C4, E4, G4
        frequencies.forEach(freq => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.setValueAtTime(freq, ctx.currentTime);
          osc.type = 'sine';
          gain.gain.setValueAtTime(0.15, ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.5);
          osc.start(ctx.currentTime);
          osc.stop(ctx.currentTime + 0.5);
        });

        log('âœ… å’Œå¼¦æ’­æ”¾å®Œæˆ', 'success');

        setTimeout(() => {
          if (ctx.state !== 'closed') ctx.close();
        }, 600);
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ’­æ”¾éŸ³åº
    async function playSequence() {
      log('ğŸ¼ æ’­æ”¾éŸ³åº...', 'info');
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') await ctx.resume();

        const notes = [261.63, 293.66, 329.63, 349.23, 392.00]; // C D E F G
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.15);
          osc.type = 'sine';
          gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.15);
          gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + i * 0.15 + 0.02);
          gain.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.15 + 0.12);
          osc.start(ctx.currentTime + i * 0.15);
          osc.stop(ctx.currentTime + i * 0.15 + 0.12);
        });

        log('âœ… éŸ³åºæ’­æ”¾å®Œæˆ', 'success');

        setTimeout(() => {
          if (ctx.state !== 'closed') ctx.close();
        }, 1000);
      } catch (error) {
        log(`âŒ å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æµ‹è¯•å‘éŸ³
    function testSpeak(word) {
      log(`ğŸ—£ï¸ å‘éŸ³: "${word}"`, 'info');
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = 'en-US';
      utterance.rate = 0.8;

      utterance.onstart = () => log(`"${word}" å¼€å§‹æ’­æ”¾`, 'success');
      utterance.onend = () => log(`"${word}" æ’­æ”¾ç»“æŸ`, 'success');
      utterance.onerror = (e) => log(`"${word}" å¤±è´¥: ${e.error}`, 'error');

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    // å¤‡é€‰æ–¹æ¡ˆ
    async function testFallback(word) {
      log(`ğŸ”„ å¤‡é€‰éŸ³é¢‘: "${word}"`, 'info');
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') await ctx.resume();

        const letters = word.split('');
        letters.forEach((letter, i) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.frequency.setValueAtTime(300 + (letter.charCodeAt(0) % 26) * 20 + i * 50, ctx.currentTime + i * 0.1);
          osc.type = 'sine';
          gain.gain.setValueAtTime(0, ctx.currentTime + i * 0.1);
          gain.gain.linearRampToValueAtTime(0.2, ctx.currentTime + i * 0.1 + 0.02);
          gain.gain.linearRampToValueAtTime(0, ctx.currentTime + i * 0.1 + 0.08);
          osc.start(ctx.currentTime + i * 0.1);
          osc.stop(ctx.currentTime + i * 0.1 + 0.08);
        });

        log(`âœ… å¤‡é€‰éŸ³é¢‘æ’­æ”¾å®Œæˆ (${letters.length} ä¸ªéŸ³è°ƒ)`, 'success');

        setTimeout(() => {
          if (ctx.state !== 'closed') ctx.close();
        }, (letters.length * 100) + 300);
      } catch (error) {
        log(`âŒ å¤‡é€‰æ–¹æ¡ˆå¤±è´¥: ${error.message}`, 'error');
      }
    }

    // è§†è§‰åé¦ˆ
    function testVisual(word) {
      log(`ğŸ‘ï¸ è§†è§‰åé¦ˆ: "${word}"`, 'info');
      const testWord = document.getElementById('testWord');
      testWord.textContent = word.toUpperCase();
      testWord.style.display = 'block';

      setTimeout(() => {
        testWord.style.display = 'none';
      }, 1500);

      if ('vibrate' in navigator) {
        navigator.vibrate([100, 50, 100]);
        log('âœ… è§†è§‰åé¦ˆ + æŒ¯åŠ¨', 'success');
      }
    }

    // æŒ¯åŠ¨æµ‹è¯•
    function testVibrate() {
      if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
        log('âœ… æŒ¯åŠ¨æ¨¡å¼: [200, 100, 200]', 'success');
      } else {
        log('âŒ æŒ¯åŠ¨ API ä¸å­˜åœ¨', 'error');
      }
    }

    // è¿è¡Œå®Œæ•´è¯Šæ–­
    async function runFullDiagnostic() {
      results.innerHTML = '';
      log('========== å¼€å§‹å®Œæ•´è¯Šæ–­ ==========', 'info');
      log(`è®¾å¤‡: ${detectDevice() ? 'å°ç±³' : 'å…¶ä»–'}`, 'info');
      log(`User Agent: ${navigator.userAgent.substring(0, 100)}`, 'info');

      await testWebAudio();
      await new Promise(r => setTimeout(r, 500));

      await testHTML5Audio();
      await new Promise(r => setTimeout(r, 500));

      await testWebSpeech();
      await new Promise(r => setTimeout(r, 500));

      testVibrate();

      log('========== è¯Šæ–­å®Œæˆ ==========', 'info');
      log('è¯·æ£€æŸ¥æ˜¯å¦å¬åˆ°ä»»ä½•å£°éŸ³', 'info');
    }

    // æµ‹è¯•æ‰€æœ‰æ–¹æ¡ˆ
    async function testAll() {
      results.innerHTML = '';
      log('========== æµ‹è¯•æ‰€æœ‰æ–¹æ¡ˆ ==========', 'info');

      const testWord = 'test';
      log(`æµ‹è¯•å•è¯: "${testWord}"`, 'info');

      // 1. Web Audio
      await playTone(440);
      await new Promise(r => setTimeout(r, 500));

      // 2. Web Speech
      await new Promise(r => {
        const u = new SpeechSynthesisUtterance(testWord);
        u.onend = r;
        u.onerror = r;
        window.speechSynthesis.speak(u);
      });
      await new Promise(r => setTimeout(r, 1000));

      // 3. å¤‡é€‰éŸ³é¢‘
      await testFallback(testWord);
      await new Promise(r => setTimeout(r, 800));

      // 4. è§†è§‰åé¦ˆ
      testVisual(testWord);

      log('========== æµ‹è¯•å®Œæˆ ==========', 'info');
      log('å“ªä¸ªæ–¹æ¡ˆæœ‰å£°éŸ³ï¼Ÿ', 'info');
    }

    // åˆå§‹åŒ–
    detectDevice();
  </script>
</body>
</html>
